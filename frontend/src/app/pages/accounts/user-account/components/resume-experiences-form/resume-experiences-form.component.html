<section class="p-6 bg-gray-100 rounded-lg shadow-md mt-3">
  <div class="flex justify-between">
    <h2 class="text-2xl font-bold text-gray-700 mb-4">Опыт работы</h2>
    <button
      mat-fab
      color="accent"
      type="button"
      (click)="addJobExperience()"
      class="text-3xl transform scale-[0.55] align-middle"
    >
      <mat-icon matSuffix>add</mat-icon>
    </button>
  </div>

  <form [formGroup]="jobExperiencesForm" (ngSubmit)="saveJobExperiences()">
    <ng-container formArrayName="jobExperiences">
      <hr
        *ngIf="jobExperiences.length > 0"
        class="border-t-1 border-blue-300"
      />

      <ng-container
        class="w-full"
        *ngFor="let jobExperienceForm of jobExperiences.controls; let i = index"
      >
        <div class="flex flex-row align-middle">
          <div [formGroupName]="i">
            <span class="text-2xl font-bold">{{ i + 1 }}:</span>
            <mat-form-field color="primary" class="w-full" appearance="fill">
              <mat-label>Должность</mat-label>

              <input
                matInput
                formControlName="jobTitle"
                aria-describedby="experiencejobTitleError-{{ i }}"
                required
              />

              <mat-error id="experiencejobTitleError-{{ i }}">
                <ng-container
                  *ngIf="
                    jobExperiences.controls[i]
                      .get('jobTitle')
                      ?.hasError('required')
                  "
                >
                  Введите или удалите опыт работы
                </ng-container>
              </mat-error>
            </mat-form-field>

            <mat-form-field color="primary" class="w-full" appearance="fill">
              <mat-label>Название компании</mat-label>

              <input
                matInput
                formControlName="companyName"
                aria-describedby="experienceCompanyNameError-{{ i }}"
                required
              />

              <mat-error id="experienceCompanyNameError-{{ i }}">
                <ng-container
                  *ngIf="
                    jobExperiences.controls[i]
                      .get('companyName')
                      ?.hasError('required')
                  "
                >
                  Введите или удалите опыт работы
                </ng-container>
              </mat-error>
            </mat-form-field>

            <mat-form-field color="primary" class="w-full" appearance="fill">
              <mat-label>Дата начала</mat-label>

              <input
                matInput
                [matDatepicker]="experienceStartDate"
                formControlName="startDate"
                aria-describedby="experienceStartDateError-{{ i }}"
                required
                readonly
              />
              <mat-datepicker-toggle
                matIconSuffix
                [for]="experienceStartDate"
              ></mat-datepicker-toggle>
              <mat-datepicker #experienceStartDate>
                <mat-datepicker-actions>
                  <button mat-button matDatepickerCancel>Отмена</button>
                  <button mat-raised-button matDatepickerApply>Применить</button>
                </mat-datepicker-actions>
              </mat-datepicker>

              <mat-error id="experienceStartDateError-{{ i }}">
                <ng-container
                  *ngIf="
                    jobExperiences.controls[i]
                      .get('startDate')
                      ?.hasError('required')
                  "
                >
                  Выберите дату или удалите опыт работы
                </ng-container>
              </mat-error>
            </mat-form-field>

            <mat-form-field color="primary" class="w-full" appearance="fill">
              <mat-label>Дата окончания</mat-label>

              <input
                matInput
                [matDatepicker]="experienceEndDate"
                formControlName="endDate"
                aria-describedby="experienceEndDateError-{{ i }}"
                required
                readonly
              />
              <mat-datepicker-toggle
                matIconSuffix
                [for]="experienceEndDate"
              ></mat-datepicker-toggle>
              <mat-datepicker #experienceEndDate>
                <mat-datepicker-actions>
                  <button mat-button matDatepickerCancel>Отмена</button>
                  <button mat-raised-button matDatepickerApply>Применить</button>
                </mat-datepicker-actions>
              </mat-datepicker>

              <mat-error id="experienceEndDateError-{{ i }}">
                <ng-container
                  *ngIf="
                    jobExperiences.controls[i]
                      .get('endDate')
                      ?.hasError('required')
                  "
                >
                  Выберите дату или удалите опыт работы
                </ng-container>
              </mat-error>
            </mat-form-field>

            <!-- Responsibilities -->
            <div
              formArrayName="responsibilities"
              class="p-2 bg-gray-50 rounded-md"
            >
              <div class="flex justify-between">
                <h3 class="text-lg font-medium">Обязанности</h3>

                <button
                  mat-fab
                  color="accent"
                  type="button"
                  (click)="addResponsibility(i)"
                  class="text-3xl transform scale-[0.55] align-middle"
                >
                  <mat-icon matSuffix>add</mat-icon>
                </button>
              </div>

              <div
                *ngFor="
                  let techControl of getResponsibilities(i).controls;
                  let j = index
                "
                class="flex space-x-2 items-center mt-2"
              >
                <mat-form-field appearance="fill" class="flex-1">
                  <mat-label>Обязанность {{ j + 1 }}</mat-label>
                  <input
                    matInput
                    [formControlName]="j"
                    required
                    aria-describedby="experienceRespError-{{ i }}:{{ j }}"
                  />

                  <mat-error id="experienceRespError-{{ i }}:{{ j }}">
                    <ng-container
                      *ngIf="getResponsibilities(i).at(j)?.hasError('required')"
                    >
                      Введите или удалите опыт работы
                    </ng-container>
                  </mat-error>
                </mat-form-field>
                <button
                  mat-icon-button
                  color="warn"
                  type="button"
                  (click)="removeResponsibility(i, j)"
                >
                  <mat-icon>close</mat-icon>
                </button>
              </div>
            </div>
          </div>

          <div
            (click)="removeJobExperience(i)"
            class="hover:cursor-pointer hover:bg-red-400 rounded-xl flex align-middle items-center justify-center p-3 mb-[22px]"
          >
            <mat-icon matSuffix> close</mat-icon>
          </div>
        </div>
      </ng-container>
    </ng-container>

    <button mat-raised-button color="primary" type="submit">
      Сохранить опыт работы
    </button>
  </form>
</section>
