<div class="glass-card h-full flex flex-col">
  <div class="p-4 border-b border-[var(--border-color)]">
    <div *ngIf="isForUser()" class="flex items-center justify-between">
      <div>
        <h2 class="text-lg font-bold text-[var(--text-primary)]">
          {{ chat?.application?.vacancy?.title }}
        </h2>
        <div class="flex gap-4 mt-1">
          <button
            (click)="goToCompany()"
            class="text-sm text-accent-500 hover:underline flex items-center gap-1"
          >
            <mat-icon class="text-sm">business</mat-icon>
            Компания
          </button>
          <button
            (click)="goToVacancy()"
            class="text-sm text-accent-500 hover:underline flex items-center gap-1"
          >
            <mat-icon class="text-sm">work</mat-icon>
            Вакансия
          </button>
        </div>
      </div>
    </div>
    <div *ngIf="isForCompany()" class="flex items-center justify-between">
      <div>
        <h2 class="text-lg font-bold text-[var(--text-primary)]">
          {{ user?.firstName }} {{ user?.lastName }}
        </h2>
        <button
          (click)="goToResume()"
          class="text-sm text-accent-500 hover:underline flex items-center gap-1 mt-1"
        >
          <mat-icon class="text-sm">description</mat-icon>
          Резюме
        </button>
      </div>
      <div *ngIf="chat?.application?.status === ApplicationStatus.Unread" class="flex gap-2">
        <button
          (click)="updateStatus(ApplicationStatus.Rejected)"
          class="glass-btn-danger py-2 px-4 text-sm inline-flex items-center gap-1.5"
        >
          <mat-icon class="text-sm">close</mat-icon>
          Отклонить
        </button>
        <button
          (click)="updateStatus(ApplicationStatus.Accepted)"
          class="glass-btn-success py-2 px-4 text-sm inline-flex items-center gap-1.5"
        >
          <mat-icon class="text-sm">check</mat-icon>
          Принять
        </button>
      </div>
    </div>
  </div>
  <div
    class="flex-1 overflow-y-auto custom-scrollbar p-4 space-y-3 flex flex-col-reverse"
    (scroll)="onScroll($event)"
    #scrollContainer
  >
    <div
      *ngFor="let message of messages; let i = index"
      class="relative"
      [class.bg-primary-500]="showContextMenu && selectedMessageIndex === i"
      [class.rounded-xl]="showContextMenu && selectedMessageIndex === i"
      [id]="'message-' + i"
    >
      <app-message
        [message]="message"
        [senderId]="currentSenderId"
        (contextmenu)="currentSenderId === message.senderId ? onRightClick($event, message, i) : undefined"
      ></app-message>
      <app-message-context-menu
        *ngIf="showContextMenu && selectedMessageIndex === i"
        (edit)="onEditMessage()"
        (copy)="onCopyClick()"
      ></app-message-context-menu>
    </div>
  </div>
  <div class="p-4 border-t border-[var(--border-color)]">
    <div *ngIf="isEditing" class="mb-3">
      <div class="glass-card-subtle p-3 rounded-xl flex items-start justify-between">
        <div>
          <span class="text-xs text-accent-500 font-medium">Редактирование</span>
          <p class="text-sm text-[var(--text-secondary)] mt-1 line-clamp-2">
            {{ selectedMessage?.content }}
          </p>
        </div>
        <button
          (click)="cancelEditing()"
          class="text-[var(--text-muted)] hover:text-error-500"
        >
          <mat-icon>close</mat-icon>
        </button>
      </div>
    </div>
    <div class="flex gap-3">
      <input
        type="text"
        [(ngModel)]="messageInput"
        [placeholder]="isEditing ? 'Новый текст...' : 'Сообщение...'"
        class="glass-input flex-1"
        (keyup.enter)="isEditing ? submitEditMessage(messageInput) : sendMessage(messageInput)"
      />
      <button
        (click)="isEditing ? submitEditMessage(messageInput) : sendMessage(messageInput)"
        class="glass-btn py-3 px-6"
      >
        <mat-icon>{{ isEditing ? 'check' : 'send' }}</mat-icon>
      </button>
    </div>
  </div>
</div>
