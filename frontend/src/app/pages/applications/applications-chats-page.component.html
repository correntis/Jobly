<app-header />

<div class="flex h-[calc(100vh-5rem)] p-6 gap-4">
  <!-- Sidebar with Chats -->
  <aside class="w-80 lg:w-96 flex-shrink-0 glass-card flex flex-col">
    <!-- Header -->
    <div class="p-4 border-b border-[var(--border-color)]">
      <h2 class="text-xl font-bold text-[var(--text-primary)] font-display">
        {{ isForUser() ? 'Ваши отклики' : 'Кандидаты' }}
      </h2>
      <p class="text-sm text-[var(--text-secondary)]">
        {{ getFilteredChatsCount() }} {{ getFilteredChatsCount() === 1 ? 'чат' : 'чатов' }}
      </p>
    </div>

    <!-- Filters -->
    <div class="p-4 border-b border-[var(--border-color)]">
      <h3 class="text-sm font-semibold text-[var(--text-primary)] mb-3">Фильтр по статусу</h3>
      <div class="flex flex-wrap gap-2">
        <button
          (click)="onStatusFilterChange('All')"
          class="glass-btn-secondary px-3 py-1.5 text-xs flex items-center gap-1.5 transition-all"
          [class.bg-primary-500]="selectedStatus === 'All'"
          [class.text-white]="selectedStatus === 'All'"
          [class.border-primary-500]="selectedStatus === 'All'"
        >
          <span>Все</span>
          <span class="glass-tag text-xs px-1.5 py-0.5" *ngIf="getStatusCount('All') > 0">
            {{ getStatusCount('All') }}
          </span>
        </button>
        <button
          (click)="onStatusFilterChange(ApplicationStatus.Unread)"
          class="glass-btn-secondary px-3 py-1.5 text-xs flex items-center gap-1.5 transition-all"
          [class.bg-warning-500]="selectedStatus === ApplicationStatus.Unread"
          [class.text-white]="selectedStatus === ApplicationStatus.Unread"
          [class.border-warning-500]="selectedStatus === ApplicationStatus.Unread"
        >
          <mat-icon class="text-sm">schedule</mat-icon>
          <span>Новые</span>
          <span class="glass-tag text-xs px-1.5 py-0.5" *ngIf="getStatusCount(ApplicationStatus.Unread) > 0">
            {{ getStatusCount(ApplicationStatus.Unread) }}
          </span>
        </button>
        <button
          (click)="onStatusFilterChange(ApplicationStatus.Accepted)"
          class="glass-btn-secondary px-3 py-1.5 text-xs flex items-center gap-1.5 transition-all"
          [class.bg-success-500]="selectedStatus === ApplicationStatus.Accepted"
          [class.text-white]="selectedStatus === ApplicationStatus.Accepted"
          [class.border-success-500]="selectedStatus === ApplicationStatus.Accepted"
        >
          <mat-icon class="text-sm">check_circle</mat-icon>
          <span>Приняты</span>
          <span class="glass-tag text-xs px-1.5 py-0.5" *ngIf="getStatusCount(ApplicationStatus.Accepted) > 0">
            {{ getStatusCount(ApplicationStatus.Accepted) }}
          </span>
        </button>
        <button
          (click)="onStatusFilterChange(ApplicationStatus.Rejected)"
          class="glass-btn-secondary px-3 py-1.5 text-xs flex items-center gap-1.5 transition-all"
          [class.bg-error-500]="selectedStatus === ApplicationStatus.Rejected"
          [class.text-white]="selectedStatus === ApplicationStatus.Rejected"
          [class.border-error-500]="selectedStatus === ApplicationStatus.Rejected"
        >
          <mat-icon class="text-sm">cancel</mat-icon>
          <span>Отклонены</span>
          <span class="glass-tag text-xs px-1.5 py-0.5" *ngIf="getStatusCount(ApplicationStatus.Rejected) > 0">
            {{ getStatusCount(ApplicationStatus.Rejected) }}
          </span>
        </button>
      </div>
    </div>

    <!-- Chat List -->
    <div 
      class="flex-1 overflow-y-auto custom-scrollbar p-3 space-y-2"
      (scroll)="onChatsScroll($event)"
    >
      <div *ngIf="chats.length === 0" class="text-center py-8">
        <div class="w-16 h-16 rounded-2xl bg-[var(--bg-tertiary)] flex items-center justify-center mx-auto mb-4">
          <mat-icon class="text-3xl text-[var(--text-muted)]">chat_bubble_outline</mat-icon>
        </div>
        <p class="text-[var(--text-secondary)]">
          {{ selectedStatus === 'All' ? 'Чаты не найдены' : 'Чаты с выбранным статусом не найдены' }}
        </p>
      </div>

      <app-compact-chat
        *ngFor="let chat of chats; let i = index"
        (click)="openChat(chat)"
        [chat]="chat"
        [application]="chat?.application"
        [isActivated]="i === activeChatIndex"
        [forRole]="forRole"
        class="block"
      />
    </div>
  </aside>

  <!-- Chat Area -->
  <main class="flex-1">
    <app-full-chat
      *ngIf="selectedChat"
      [chat]="selectedChat"
      [messages]="selectedChat.messages"
      [forRole]="forRole"
      [currentSenderId]="requestsId"
      [currentRecipientId]="getSelectedChatRecipientId()"
      (statusChanged)="onApplicationStatusChanged($event.chatId, $event.newStatus)"
    />

    <!-- Empty State -->
    <div *ngIf="!selectedChat" class="glass-card h-full flex flex-col items-center justify-center">
      <div class="w-20 h-20 rounded-2xl bg-[var(--bg-tertiary)] flex items-center justify-center mb-4">
        <mat-icon class="text-4xl text-[var(--text-muted)]">forum</mat-icon>
      </div>
      <h3 class="text-xl font-semibold text-[var(--text-primary)] mb-2">Выберите чат</h3>
      <p class="text-[var(--text-secondary)]">Нажмите на чат слева</p>
    </div>
  </main>
</div>
